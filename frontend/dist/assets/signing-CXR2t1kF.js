import{s as J,u as $,d as g,e as j}from"./to-serializable-transaction-CBqCJM9h.js";import{concatHex as Q}from"./concat-hex-7vrtgKNj.js";import{b9 as m,aa as X,b5 as V,bg as ee,aP as D,b2 as E,bh as te,ac as re,bi as ne,bj as ie,bk as se,bl as ae,a5 as oe,as as B,g as w,aE as ce,aO as ue,bm as fe,bn as O,bo as de,aA as y,bp as F,bq as le,aB as U}from"./index-anYD-FGg.js";import{a as x,k as be,b as k,e as pe,v as ye,h as me}from"./TypedData-DnI-ZWEX.js";import{c as H}from"./parse-typed-data-B5i2uSeh.js";import{r as T,e as he}from"./read-contract-Cc_S5oDR.js";import{p as R}from"./index-DGhR22ix.js";import"./stringify-cJu1y5js.js";import"./bundler-CYXS_Fi0.js";import"./addresses-Cbjra2SQ.js";import"./send-eip712-transaction-DutKbSws.js";import"./eth_sendRawTransaction-DPdnXbFR.js";import"./random-Du27Yl4n.js";import"./send-transaction-B8v_N8Fr.js";function ge(e){for(const t of e)if(typeof t!="string")return!1;return!0}function we(e){return ge(e)?J(e):e}function I(e){let t=!0,r="",n=0,i="",a=!1;for(let s=0;s<e.length;s++){const o=e[s];if(["(",")",","].includes(o)&&(t=!0),o==="("&&n++,o===")"&&n--,!!t){if(n===0){if(o===" "&&["event","function","error",""].includes(i))i="";else if(i+=o,o===")"){a=!0;break}continue}if(o===" "){e[s-1]!==","&&r!==","&&r!==",("&&(r="",t=!1);continue}i+=o,r+=o}}if(!a)throw new m("Unable to normalize signature.");return i}function P(e,t){const r=typeof e,n=t.type;switch(n){case"address":return x(e,{strict:!1});case"bool":return r==="boolean";case"function":return r==="string";case"string":return r==="string";default:return n==="tuple"&&"components"in t?Object.values(t.components).every((i,a)=>P(Object.values(e)[a],i)):/^u?int(8|16|24|32|40|48|56|64|72|80|88|96|104|112|120|128|136|144|152|160|168|176|184|192|200|208|216|224|232|240|248|256)?$/.test(n)?r==="number"||r==="bigint":/^bytes([1-9]|1[0-9]|2[0-9]|3[0-2])?$/.test(n)?r==="string"||e instanceof Uint8Array:/[a-z]+[1-9]{0,3}(\[[0-9]{0,}\])+$/.test(n)?Array.isArray(e)&&e.every(i=>P(i,{...t,type:n.replace(/(\[[0-9]{0,}\])$/,"")})):!1}}function N(e,t,r){for(const n in e){const i=e[n],a=t[n];if(i.type==="tuple"&&a.type==="tuple"&&"components"in i&&"components"in a)return N(i.components,a.components,r[n]);const s=[i.type,a.type];if(s.includes("address")&&s.includes("bytes20")?!0:s.includes("address")&&s.includes("string")?x(r[n],{strict:!1}):s.includes("address")&&s.includes("bytes")?x(r[n],{strict:!1}):!1)return s}}function ve(e,t,r){const{args:n=[],prepare:i=!0}=r??{},a=X(t,{strict:!1}),s=e.filter(c=>a?c.type==="function"||c.type==="error"?C(c)===V(t,0,4):c.type==="event"?h(c)===t:!1:"name"in c&&c.name===t);if(s.length===0)throw new v({name:t});if(s.length===1)return{...s[0],...i?{hash:h(s[0])}:{}};let o;for(const c of s){if(!("inputs"in c))continue;if(!n||n.length===0){if(!c.inputs||c.inputs.length===0)return{...c,...i?{hash:h(c)}:{}};continue}if(!c.inputs||c.inputs.length===0||c.inputs.length!==n.length)continue;if(n.every((f,b)=>{const d="inputs"in c&&c.inputs[b];return d?P(f,d):!1})){if(o&&"inputs"in o&&o.inputs){const f=N(c.inputs,o.inputs,n);if(f)throw new Ee({abiItem:c,type:f[0]},{abiItem:o,type:f[1]})}o=c}}const l=(()=>{if(o)return o;const[c,...u]=s;return{...c,overloads:u}})();if(!l)throw new v({name:t});return{...l,...i?{hash:h(l)}:{}}}function C(e){return V(h(e),0,4)}function Ae(e){const t=typeof e=="string"?e:$(e);return I(t)}function h(e){return typeof e!="string"&&"hash"in e&&e.hash?e.hash:be(ee(Ae(e)))}class Ee extends m{constructor(t,r){super("Found ambiguous types in overloaded ABI Items.",{metaMessages:[`\`${t.type}\` in \`${I($(t.abiItem))}\`, and`,`\`${r.type}\` in \`${I($(r.abiItem))}\``,"","These types encode differently and cannot be distinguished at runtime.","Remove one of the ambiguous items in the ABI."]}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"AbiItem.AmbiguityError"})}}class v extends m{constructor({name:t,data:r,type:n="item"}){const i=t?` with name "${t}"`:r?` with data "${r}"`:"";super(`ABI ${n}${i} not found.`),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"AbiItem.NotFoundError"})}}function Se(e,t){var i;const{bytecode:r,args:n}=t;return D(r,(i=e.inputs)!=null&&i.length&&(n!=null&&n.length)?k(e.inputs,n):"0x")}function $e(e){const t=e.find(r=>r.type==="constructor");if(!t)throw new v({name:"constructor"});return t}function xe(e,...t){const{overloads:r}=e,n=r?z([e,...r],e.name,{args:t[0]}):e,i=Te(n),a=t.length>0?k(n.inputs,t[0]):void 0;return a?D(i,a):i}function z(e,t,r){const n=ve(e,t,r);if(n.type!=="function")throw new v({name:t,type:"function"});return n}function Te(e){return C(e)}function Ie(e,t={}){const{recovered:r}=t;if(typeof e.r>"u")throw new S({signature:e});if(typeof e.s>"u")throw new S({signature:e});if(r&&typeof e.yParity>"u")throw new S({signature:e});if(e.r<0n||e.r>H)throw new De({value:e.r});if(e.s<0n||e.s>H)throw new Be({value:e.s});if(typeof e.yParity=="number"&&e.yParity!==0&&e.yParity!==1)throw new L({value:e.yParity})}function Pe(e){Ie(e);const t=e.r,r=e.s;return D(E(t,{size:32}),E(r,{size:32}),typeof e.yParity=="number"?E(Ve(e.yParity),{size:1}):"0x")}function Ve(e){if(e===0)return 27;if(e===1)return 28;throw new L({value:e})}class S extends m{constructor({signature:t}){super(`Signature \`${te(t)}\` is missing either an \`r\`, \`s\`, or \`yParity\` property.`),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"Signature.MissingPropertiesError"})}}class De extends m{constructor({value:t}){super(`Value \`${t}\` is an invalid r value. r must be a positive integer less than 2^256.`),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"Signature.InvalidRError"})}}class Be extends m{constructor({value:t}){super(`Value \`${t}\` is an invalid s value. s must be a positive integer less than 2^256.`),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"Signature.InvalidSError"})}}class L extends m{constructor({value:t}){super(`Value \`${t}\` is an invalid y-parity value. Y-parity must be 0 or 1.`),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"Signature.InvalidYParityError"})}}function Me(e,t){const r={to:t};switch(r.to){case"number":return He(e,r);case"bigint":return _e(e,r);case"boolean":return Oe(e,r);case"string":return je(e,r);default:return re(e,r)}}function _e(e,t={}){return se(e,t)}function Oe(e,t={}){return ie(e,t)}function He(e,t={}){return ae(e,t)}function je(e,t={}){return ne(e,t)}const Fe="0x6492649264926492649264926492649264926492649264926492649264926492",Ue="0x608060405234801561001057600080fd5b5060405161069438038061069483398101604081905261002f9161051e565b600061003c848484610048565b9050806000526001601ff35b60007f64926492649264926492649264926492649264926492649264926492649264926100748361040c565b036101e7576000606080848060200190518101906100929190610577565b60405192955090935091506000906001600160a01b038516906100b69085906105dd565b6000604051808303816000865af19150503d80600081146100f3576040519150601f19603f3d011682016040523d82523d6000602084013e6100f8565b606091505b50509050876001600160a01b03163b60000361016057806101605760405162461bcd60e51b815260206004820152601e60248201527f5369676e617475726556616c696461746f723a206465706c6f796d656e74000060448201526064015b60405180910390fd5b604051630b135d3f60e11b808252906001600160a01b038a1690631626ba7e90610190908b9087906004016105f9565b602060405180830381865afa1580156101ad573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906101d19190610633565b6001600160e01b03191614945050505050610405565b6001600160a01b0384163b1561027a57604051630b135d3f60e11b808252906001600160a01b03861690631626ba7e9061022790879087906004016105f9565b602060405180830381865afa158015610244573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906102689190610633565b6001600160e01b031916149050610405565b81516041146102df5760405162461bcd60e51b815260206004820152603a602482015260008051602061067483398151915260448201527f3a20696e76616c6964207369676e6174757265206c656e6774680000000000006064820152608401610157565b6102e7610425565b5060208201516040808401518451859392600091859190811061030c5761030c61065d565b016020015160f81c9050601b811480159061032b57508060ff16601c14155b1561038c5760405162461bcd60e51b815260206004820152603b602482015260008051602061067483398151915260448201527f3a20696e76616c6964207369676e617475726520762076616c756500000000006064820152608401610157565b60408051600081526020810180835289905260ff83169181019190915260608101849052608081018390526001600160a01b0389169060019060a0016020604051602081039080840390855afa1580156103ea573d6000803e3d6000fd5b505050602060405103516001600160a01b0316149450505050505b9392505050565b600060208251101561041d57600080fd5b508051015190565b60405180606001604052806003906020820280368337509192915050565b6001600160a01b038116811461045857600080fd5b50565b634e487b7160e01b600052604160045260246000fd5b60005b8381101561048c578181015183820152602001610474565b50506000910152565b600082601f8301126104a657600080fd5b81516001600160401b038111156104bf576104bf61045b565b604051601f8201601f19908116603f011681016001600160401b03811182821017156104ed576104ed61045b565b60405281815283820160200185101561050557600080fd5b610516826020830160208701610471565b949350505050565b60008060006060848603121561053357600080fd5b835161053e81610443565b6020850151604086015191945092506001600160401b0381111561056157600080fd5b61056d86828701610495565b9150509250925092565b60008060006060848603121561058c57600080fd5b835161059781610443565b60208501519093506001600160401b038111156105b357600080fd5b6105bf86828701610495565b604086015190935090506001600160401b0381111561056157600080fd5b600082516105ef818460208701610471565b9190910192915050565b828152604060208201526000825180604084015261061e816060850160208701610471565b601f01601f1916919091016060019392505050565b60006020828403121561064557600080fd5b81516001600160e01b03198116811461040557600080fd5b634e487b7160e01b600052603260045260246000fdfe5369676e617475726556616c696461746f72237265636f7665725369676e6572",ke=[{inputs:[{name:"_signer",type:"address"},{name:"_hash",type:"bytes32"},{name:"_signature",type:"bytes"}],stateMutability:"nonpayable",type:"constructor"},{inputs:[{name:"_signer",type:"address"},{name:"_hash",type:"bytes32"},{name:"_signature",type:"bytes"}],outputs:[{type:"bool"}],stateMutability:"nonpayable",type:"function",name:"isValidSig"}];function Re(e){if(V(e,-32)!==Fe)throw new Ce(e)}function Ne(e){try{return Re(e),!0}catch{return!1}}class Ce extends m{constructor(t){super(`Value \`${t}\` is an invalid ERC-6492 wrapped signature.`),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"WrappedSignature.InvalidWrappedSignatureError"})}}const ze="0x1626ba7e",Le=[{type:"bytes32",name:"hash"},{type:"bytes",name:"signature"}],Ye=[{type:"bytes4"}];async function We(e){return T({contract:e.contract,method:[ze,Le,Ye],params:[e.hash,e.signature]})}const qe="0x6492649264926492649264926492649264926492649264926492649264926492";function M({address:e,data:t,signature:r}){return Q([g([{type:"address"},{type:"bytes"},{type:"bytes"}],[e,t,r]),qe])}const Ge="0xfB688330379976DA81eB64Fe4BF50d7401763B9C";async function Y({hash:e,signature:t,address:r,client:n,chain:i,accountFactory:a}){const s=(()=>{if(oe(t))return t;if(typeof t=="object"&&"r"in t&&"s"in t)return Pe(t);if(t instanceof Uint8Array)return Me(t,"hex");throw new Error(`Invalid signature type for signature ${t}: ${typeof t}`)})();if(await B(w({address:r,client:n,chain:i}))&&await A({hash:e,signature:s,contract:w({chain:i,address:r,client:n})}).catch(p=>(console.error("Error verifying EIP-1271 signature",p),!1)))return!0;const l=await(async()=>!a||Ne(s)?s:M({address:a.address,data:a.verificationCalldata,signature:s}))();let c;const u=await ce(i),f=we(ke);if(u)c={to:Ge,data:xe(z(f,"isValidSig"),[r,e,l])};else{const d=$e(f);c={data:Se(d,{args:[r,e,l],bytecode:Ue})}}const b=ue({chain:i,client:n});try{const d=await he(b,c);return fe(d)}catch{return!!await A({hash:e,signature:s,contract:w({chain:i,address:r,client:n})}).catch(p=>(console.error("Error verifying EIP-1271 signature",p),!1))}}const Ze="0x1626ba7e";async function A({hash:e,signature:t,contract:r}){try{return await We({hash:e,signature:t,contract:r})===Ze}catch(n){return console.error("Error verifying EIP-1271 signature",n),!1}}const Ke=`Ethereum Signed Message:
`;function Je(e,t){const r=typeof e=="string"?O(e):e.raw instanceof Uint8Array?e.raw:de(e.raw),n=O(`${Ke}${r.length}`);return y(F(n,r),t)}function Qe(e){const{domain:t={},message:r,primaryType:n}=e,i={EIP712Domain:pe(t),...e.types};ye({domain:t,message:r,primaryType:n,types:i});const a=["0x1901"];if(t&&a.push(me({domain:t,types:i})),n!=="EIP712Domain"){const s=(()=>{const o=W({data:r,primaryType:n,types:i});return y(o)})();a.push(s)}return y(F(...a.map(s=>le(s))))}function W({data:e,primaryType:t,types:r}){const n=[{type:"bytes32"}],i=[Xe({primaryType:t,types:r})];if(!r[t])throw new Error("Invalid types");for(const a of r[t]){const[s,o]=G({types:r,name:a.name,type:a.type,value:e[a.name]});n.push(s),i.push(o)}return g(n,i)}function Xe({primaryType:e,types:t}){const r=U(e0({primaryType:e,types:t}));return y(r)}function e0({primaryType:e,types:t}){let r="";const n=q({primaryType:e,types:t});n.delete(e);const i=[e,...Array.from(n).sort()];for(const a of i){if(!t[a])throw new Error("Invalid types");r+=`${a}(${t[a].map(({name:s,type:o})=>`${o} ${s}`).join(",")})`}return r}function q({primaryType:e,types:t},r=new Set){const n=e.match(/^\w*/u),i=n==null?void 0:n[0];if(r.has(i)||t[i]===void 0)return r;r.add(i);for(const a of t[i])q({primaryType:a.type,types:t},r);return r}function G({types:e,name:t,type:r,value:n}){if(e[r]!==void 0)return[{type:"bytes32"},y(W({data:n,primaryType:r,types:e}))];if(r==="bytes")return n=`0x${(n.length%2?"0":"")+n.slice(2)}`,[{type:"bytes32"},y(n)];if(r==="string")return[{type:"bytes32"},y(U(n))];if(r.lastIndexOf("]")===r.length-1){const i=r.slice(0,r.lastIndexOf("[")),a=n.map(s=>G({name:t,type:i,types:e,value:s}));return[{type:"bytes32"},y(g(a.map(([s])=>s),a.map(([,s])=>s)))]}return[{type:r},n]}async function m0({accountContract:e,factoryContract:t,options:r,message:n}){var l,c;const i=Je(n),a=await Z({factoryContract:t,accountContract:e,originalMsgHash:i});let s;if(a){const u=g([{type:"bytes32"}],[i]);s=await r.personalAccount.signTypedData({domain:{name:"Account",version:"1",chainId:r.chain.id,verifyingContract:e.address},primaryType:"AccountMessage",types:{AccountMessage:[{name:"message",type:"bytes"}]},message:{message:u}})}else s=await r.personalAccount.signMessage({message:n});if(await B(e)){if(await A({hash:i,signature:s,contract:e}))return s;throw new Error("Failed to verify signature")}else{const u=R({factoryContract:t,adminAddress:r.personalAccount.address,accountSalt:(l=r.overrides)==null?void 0:l.accountSalt,createAccountOverride:(c=r.overrides)==null?void 0:c.createAccount});if(!u)throw new Error("Create account override not provided");const f=await j(u),b=M({address:t.address,data:f,signature:s});if(await Y({hash:i,signature:b,address:e.address,chain:e.chain,client:e.client}))return b;throw new Error("Unable to verify ERC-6492 signature after signing.")}}async function h0({accountContract:e,factoryContract:t,options:r,typedData:n}){var c,u,f,b,d;if(((u=(c=n.domain)==null?void 0:c.verifyingContract)==null?void 0:u.toLowerCase())===((f=e.address)==null?void 0:f.toLowerCase()))return r.personalAccount.signTypedData(n);const a=Qe(n),s=await Z({factoryContract:t,accountContract:e,originalMsgHash:a});let o;if(s){const p=g([{type:"bytes32"}],[a]);o=await r.personalAccount.signTypedData({domain:{name:"Account",version:"1",chainId:r.chain.id,verifyingContract:e.address},primaryType:"AccountMessage",types:{AccountMessage:[{name:"message",type:"bytes"}]},message:{message:p}})}else o=await r.personalAccount.signTypedData(n);if(await B(e)){if(await A({hash:a,signature:o,contract:e}))return o;throw new Error("Failed to verify signature")}else{const p=R({factoryContract:t,adminAddress:r.personalAccount.address,accountSalt:(b=r.overrides)==null?void 0:b.accountSalt,createAccountOverride:(d=r.overrides)==null?void 0:d.createAccount});if(!p)throw new Error("Create account override not provided");const K=await j(p),_=M({address:t.address,data:K,signature:o});if(await Y({hash:a,signature:_,address:e.address,chain:e.chain,client:e.client}))return _;throw new Error("Unable to verify signature on smart account, please make sure the admin wallet has permissions and the signature is valid.")}}async function Z({factoryContract:e,accountContract:t,originalMsgHash:r}){try{const n=await T({contract:e,method:"function accountImplementation() public view returns (address)"});return await T({contract:w({address:n,chain:t.chain,client:t.client}),method:"function getMessageHash(bytes32 _hash) public view returns (bytes32)",params:[r]}).then(a=>a!=="0x").catch(()=>!1)}catch{return!1}}export{m0 as smartAccountSignMessage,h0 as smartAccountSignTypedData};
