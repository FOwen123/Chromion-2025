import{j as e,r as d,g as D,c as _,v as U,t as f,w as W}from"./index-anYD-FGg.js";import{B as O,s as h}from"./badge-B4HGYicW.js";import{C as P,d as E,e as B,b as F,f as $}from"./createLucideIcon-DyRFF-zW.js";import{S,s as I,L as R}from"./separator-BLPDsuiq.js";import{B as v}from"./index-BPYKPm2Y.js";import{u as q,a as A,b as M,c as N}from"./accounts-DaLONHDH.js";import{u as b}from"./useActiveAccount-CVe1qF18.js";import{r as T}from"./read-contract-Cc_S5oDR.js";import{C as z}from"./ConnectEmbed-Bpe-CHh8.js";import{W as H}from"./wallet-C-nmKT0u.js";import{p as G}from"./to-serializable-transaction-CBqCJM9h.js";import{s as V}from"./send-transaction-B8v_N8Fr.js";import"./TypedData-DnI-ZWEX.js";import"./parse-typed-data-B5i2uSeh.js";import"./stringify-cJu1y5js.js";import"./client-scoped-storage-Bf9eqyHt.js";import"./index-CaOpr-Oa.js";import"./types-DlKe2M91.js";import"./bundler-CYXS_Fi0.js";import"./random-Du27Yl4n.js";import"./url-XFQQWSb0.js";function J({isLoading:s,error:o}){return s?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-primary"})}):o?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs(P,{className:"w-full max-w-md",children:[e.jsx(E,{children:e.jsx(B,{children:"Payment Link Error"})}),e.jsx(F,{children:e.jsx("p",{className:"text-muted-foreground",children:o})})]})}):null}function K({paymentLink:s}){return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-3 sm:space-y-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-2xl sm:text-3xl lg:text-4xl font-bold text-primary",children:[s.amount," ",s.currency]}),e.jsx("div",{className:"text-xs sm:text-sm text-muted-foreground",children:"Payment Amount"})]}),e.jsx(S,{}),e.jsxs("div",{className:"space-y-2 sm:space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center text-xs sm:text-sm",children:[e.jsx("span",{className:"font-medium",children:"Recipient:"}),e.jsxs("span",{className:"font-mono text-xs bg-muted px-2 py-1 rounded break-all max-w-[120px] sm:max-w-none",children:[e.jsxs("span",{className:"hidden sm:inline",children:[s.creator_wallet.slice(0,6),"...",s.creator_wallet.slice(-4)]}),e.jsxs("span",{className:"sm:hidden",children:[s.creator_wallet.slice(0,4),"...",s.creator_wallet.slice(-4)]})]})]}),e.jsxs("div",{className:"flex justify-between items-center text-xs sm:text-sm",children:[e.jsx("span",{className:"font-medium",children:"Network:"}),e.jsx(O,{variant:"secondary",className:"text-xs",children:s.chain_id===11155111?"Sepolia":s.chain_id===1?"Ethereum":s.chain_id===137?"Polygon":s.chain_id===56?"BSC":s.chain_id===42161?"Arbitrum":s.chain_id===42220?"Celo":s.chain_id===8453?"Base":s.chain_id===43114?"Avalanche":"Other"})]}),e.jsxs("div",{className:"flex justify-between items-center text-xs sm:text-sm",children:[e.jsx("span",{className:"font-medium",children:"Currency:"}),e.jsx("span",{children:s.currency})]})]})]}),e.jsx(S,{})]})}const Q="0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238";function X(){const[s,o]=d.useState("0"),[l,m]=d.useState(!1),[p,n]=d.useState(null),t=b(),a=d.useCallback(async()=>{if(!(t!=null&&t.address)){o("0");return}m(!0),n(null);try{const r=D({client:_,chain:I,address:Q,abi:[{inputs:[{internalType:"address",name:"account",type:"address"}],name:"balanceOf",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"decimals",outputs:[{internalType:"uint8",name:"",type:"uint8"}],stateMutability:"view",type:"function"}]}),x=await T({contract:r,method:"balanceOf",params:[t.address]}),c=(Number(x)/1e6).toFixed(2);o(c)}catch(r){console.error("Error fetching USDC balance:",r),n("Failed to fetch balance"),o("0")}finally{m(!1)}},[t==null?void 0:t.address]);d.useEffect(()=>{a()},[a]),d.useEffect(()=>{if(!(t!=null&&t.address))return;const r=setInterval(a,3e4);return()=>clearInterval(r)},[t==null?void 0:t.address,a]);const i=d.useCallback(r=>{const x=parseFloat(s),c=x>=r;return console.log("🔍 Balance Check:",{currentBalance:x,requiredAmount:r,sufficient:c,balanceString:s}),c},[s]);return{balance:s,isLoading:l,error:p,refetch:a,hasBalance:parseFloat(s)>0,hasSufficientBalance:i}}function Y({isConnected:s,onPayment:o,isPaying:l,paymentAmount:m=0}){const{logout:p}=q(),n=b(),t=A(),{disconnect:a}=M(),{balance:i,isLoading:r,hasSufficientBalance:x}=X(),c=x(m);return console.log("💰 Payment Amount Check:",{paymentAmount:m,balance:i,hasEnoughFunds:c,isLoading:r}),s?e.jsxs("div",{className:"space-y-3 sm:space-y-4",children:[e.jsx("div",{className:"p-3 sm:p-4 bg-muted rounded-lg",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-start space-y-2 sm:space-y-0",children:[e.jsxs("div",{className:"min-w-0 flex-1 space-y-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs sm:text-sm text-muted-foreground mb-1",children:"Connected Wallet"}),e.jsxs("div",{className:"font-mono text-xs sm:text-sm break-all",children:[e.jsxs("span",{className:"hidden sm:inline",children:[n==null?void 0:n.address.slice(0,6),"...",n==null?void 0:n.address.slice(-4)]}),e.jsxs("span",{className:"sm:hidden",children:[n==null?void 0:n.address.slice(0,4),"...",n==null?void 0:n.address.slice(-4)]})]})]}),e.jsxs("div",{className:"border-t pt-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs sm:text-sm text-muted-foreground mb-1",children:[e.jsx(H,{size:14}),"USDC Balance"]}),e.jsx("div",{className:"flex items-center gap-2",children:r?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{size:14,className:"animate-spin"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Loading..."})]}):e.jsxs("div",{className:`text-sm sm:text-base font-bold ${c?"text-green-600":"text-red-600"}`,children:[i," USDC"]})}),!r&&!c&&parseFloat(i)>0&&m>0&&e.jsx("div",{className:"text-xs text-red-600 mt-1",children:"⚠️ Insufficient balance for this payment"}),!r&&parseFloat(i)===0&&e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:"💡 Get testnet USDC from a faucet"})]})]}),e.jsx(v,{variant:"outline",size:"sm",className:"text-xs sm:text-sm px-2 sm:px-3 py-1 sm:py-2 self-end sm:self-auto",onClick:async()=>{try{p(),t&&await a(t)}catch(g){console.error("Error during logout:",g)}},children:"Logout"})]})}),e.jsx(v,{onClick:o,disabled:l||!c&&m>0,className:"w-full text-sm sm:text-base py-3 sm:py-4",size:"lg",children:l?"Processing Payment...":"Pay Now"})]}):e.jsxs("div",{className:"text-center space-y-3 sm:space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg sm:text-xl font-semibold mb-2",children:"To continue with the payment, please login first"}),e.jsx("p",{className:"text-xs sm:text-sm text-muted-foreground px-2",children:"Connect your wallet to securely complete this payment"})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(z,{client:_,theme:"dark",wallets:[N("io.metamask"),N("com.coinbase.wallet"),N("me.rainbow")]})})]})}function Z({paymentLink:s,isWalletConnected:o,onPayment:l,isPaying:m}){return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-2 sm:p-4",children:e.jsx("div",{className:"w-full max-w-2xl mx-auto",children:e.jsxs(P,{className:"w-full mx-2 sm:mx-0",children:[o&&e.jsxs(E,{className:"px-4 sm:px-6",children:[e.jsx(B,{className:"text-lg sm:text-xl",children:s==null?void 0:s.title}),(s==null?void 0:s.description)&&e.jsx($,{className:"text-sm sm:text-base",children:s.description})]}),e.jsxs(F,{className:"space-y-4 sm:space-y-6 px-4 sm:px-6 pb-4 sm:pb-6",children:[o&&e.jsx(K,{paymentLink:s}),e.jsx("div",{className:"space-y-4 sm:space-y-6",children:e.jsx(Y,{isConnected:o,onPayment:l,isPaying:m,paymentAmount:s.amount})})]})]})})})}function k(){const[s,o]=d.useState(!1),l=b(),m=U(),p=d.useCallback(async(t,a)=>{try{console.log(`🔍 Checking if chain selector ${a} is whitelisted...`);const i=await T({contract:t,method:"function whitelistedDestinationChains(uint64) view returns (bool)",params:[BigInt(a)]});return console.log(`Chain ${a} whitelisted status:`,i),i?(f.success(`✅ Chain selector ${a} is properly whitelisted!`),!0):(f.error(`❌ Chain selector ${a} is NOT whitelisted!`),!1)}catch(i){return console.error("Error checking chain whitelisting:",i),f.warning("⚠️ Could not verify chain whitelisting status"),!1}},[]);return{handlePayment:d.useCallback(async t=>{if(!l||!t)return;o(!0);let a=null;try{const{data:i,error:r}=await h.from("user_profiles").select("wallet_address").eq("wallet_address",l.address).maybeSingle();!i&&!r?await h.from("user_profiles").insert({wallet_address:l.address,first_login:new Date().toISOString(),last_login:new Date().toISOString(),login_count:1,is_active:!0}):i&&await h.from("user_profiles").update({last_login:new Date().toISOString(),login_count:i.login_count+1}).eq("wallet_address",l.address);const{data:x,error:c}=await h.from("payments").insert({payment_link_id:t.id,payer_wallet:l.address,amount:t.amount,currency:t.currency,chain_id:t.chain_id,status:"pending"}).select().single();if(c)throw console.error("Payment creation error:",c),new Error(`Failed to create payment record: ${c.message}`);if(a=x,t.chain_id!==11155111)throw new Error("Only Sepolia network is currently supported");const g="0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238",j="0x05Bc05725AE7dF7BfDd94891F138Aae0f0a2C689",u=D({client:_,chain:I,address:g,abi:[{inputs:[{name:"to",type:"address"},{name:"amount",type:"uint256"}],name:"transfer",outputs:[{name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"}]});console.log("Preparing USDC transfer...");const y=BigInt(Math.floor(t.amount*1e6));console.log("💰 Amount Conversion Debug:",{originalAmount:t.amount,amountAfterMultiply:t.amount*1e6,amountAfterFloor:Math.floor(t.amount*1e6),finalAmountInWei:y.toString()}),console.log(`💸 Sending ${t.amount} USDC to contract: ${j}`);const w=G({contract:u,method:"transfer",params:[j,y]});console.log("🚀 Sending USDC transfer with params:",{to:j,amount:y.toString(),amountFormatted:t.amount}),f.info("Please confirm the transaction in your wallet...");const C=await V({account:l,transaction:w});console.log("✅ Transaction sent successfully:",C),await h.from("payments").update({tx_hash:C.transactionHash,status:"pending_delivery",paid_at:new Date().toISOString()}).eq("id",a.id),await h.from("payment_links").update({current_uses:t.current_uses+1,total_collected:t.amount+(t.total_collected||0)}).eq("id",t.id),f.success("🎉 Payment sent to contract successfully!"),f.success(`Transaction Hash: ${C.transactionHash.slice(0,10)}...`,{action:{label:"View on Etherscan",onClick:()=>window.open(`https://sepolia.etherscan.io/tx/${C.transactionHash}`,"_blank")}}),setTimeout(()=>{m.navigate({to:"/processfunds",search:{paymentId:a.id}})},2e3)}catch(i){console.error("Payment failed:",i),a&&await h.from("payments").update({status:"failed"}).eq("id",a.id);const r=i instanceof Error?i.message:"Unknown error occurred";r.includes("DestinationChainNotWhitelisted")?f.error("❌ Chain not whitelisted! Please contact support."):r.includes("AccessControlUnauthorizedAccount")?f.error("❌ Insufficient permissions. Please check your wallet has the required role."):f.error(`❌ Payment failed: ${r}`)}finally{o(!1)}},[l,m,p]),isPaying:s}}const we=function(){const{linkId:o}=W.useParams(),l=b(),{handlePayment:m,isPaying:p}=k(),[n,t]=d.useState(null),[a,i]=d.useState(!0),[r,x]=d.useState(null),c=!!l,g=d.useCallback(async()=>{try{const{data:u,error:y}=await h.from("payment_links").select("*").eq("short_id",o).eq("status","active").single();if(y)throw y;if(u.expires_at&&new Date(u.expires_at)<new Date){x("This payment link has expired");return}if(u.max_uses&&u.current_uses>=u.max_uses){x("This payment link has reached its maximum number of uses");return}console.log("Payment link data from database:",u);const w={...u,currency:u.currency||"USDC",chain_id:u.chain_id||11155111};console.log("Processed payment link data:",w),t(w)}catch(u){console.error("Error fetching payment link:",u),x("Payment link not found or is no longer active")}finally{i(!1)}},[o]);d.useEffect(()=>{g()},[g]);const j=()=>{n&&m(n)};return a||r?e.jsx(J,{isLoading:a,error:r}):n?e.jsx(Z,{paymentLink:n,isWalletConnected:c,onPayment:j,isPaying:p}):null};export{we as component};
