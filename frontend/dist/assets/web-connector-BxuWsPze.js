const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/eth_getTransactionCount-BCMAqULb.js","assets/index-anYD-FGg.js","assets/index-SGLETCTz.css","assets/passkeys-DpDg0PTU.js","assets/client-scoped-storage-Bf9eqyHt.js"])))=>i.map(i=>d[i]);
import{av as h,ae as p,af as w,a7 as f,aO as v,T,aB as A,_ as D,a5 as G,aW as b,$ as P,aX as C,aY as x}from"./index-anYD-FGg.js";import{g as L,a as W,l as Q,b as q}from"./oauth-CC2pU2pg.js";import{C as S,I as H}from"./client-scoped-storage-Bf9eqyHt.js";import{r as V}from"./random-Du27Yl4n.js";import{signLoginPayload as J}from"./sign-login-payload-BS5pcbMU.js";import{f as Y,t as _}from"./stringify-cJu1y5js.js";import{e as F}from"./eth_sendRawTransaction-DPdnXbFR.js";import{p as N}from"./parse-typed-data-B5i2uSeh.js";import"./types-DlKe2M91.js";const I=new Map,X={getItem:async i=>I.get(i)??null,setItem:async(i,e)=>{I.set(i,e)},removeItem:async i=>{I.delete(i)}};async function E({authToken:i,client:e,ecosystem:t}){const s=await h(e,t)(`${p("inAppWallet")}/api/2024-05-05/accounts`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer embedded-wallet-token:${i}`}});if(!s.ok){const o=await s.text().catch(()=>"Unknown error");throw new Error(`Failed to get user info: ${o}`)}return await s.json()}const K=p("inAppWallet"),Z=`${K}/`,U=`${Z}api/2023-10-20`,ee=`${U}/embedded-wallet/validate-custom-jwt`,te=`${U}/embedded-wallet/validate-custom-auth-endpoint`,B=(i,e)=>e instanceof Error?`${i}: ${e.message}`:`${i}: ${w(e)}`;async function ae(i){const t=await h(i.client,i.ecosystem)(te,{method:"POST",headers:{"Content-Type":"application/json"},body:w({payload:i.payload,developerClientId:i.client.clientId})});if(!t.ok){const a=await t.json();throw new Error(`Custom auth endpoint authentication error: ${a.message}`)}try{const{verifiedToken:a}=await t.json();return{storedToken:a}}catch(a){throw new Error(B("Malformed response from post auth_endpoint authentication",a))}}async function ie(i){const e=h(i.client,i.ecosystem),t=L({authOption:"backend",client:i.client,ecosystem:i.ecosystem}),a=await e(`${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:w({walletSecret:i.walletSecret})});if(!a.ok)throw new Error("Failed to generate backend account");return await a.json()}async function ne(i){const e=new S({storage:i.storage,clientId:i.client.clientId,ecosystem:i.ecosystem});let t=await e.getGuestSessionId();t||(t=V(32),e.saveGuestSessionId(t));const a=h(i.client,i.ecosystem),s=W({authOption:"guest",client:i.client,ecosystem:i.ecosystem}),o=await a(`${s}`,{method:"POST",headers:{"Content-Type":"application/json"},body:w({sessionId:t})});if(!o.ok){const n=await o.text();throw new Error(`Failed to generate guest account: ${o.status} ${o.statusText} ${n}`)}return await o.json()}async function re(i){const t=await h(i.client,i.ecosystem)(ee,{method:"POST",headers:{"Content-Type":"application/json"},body:w({jwt:i.jwt,developerClientId:i.client.clientId})});if(!t.ok){const a=await t.json();throw new Error(`JWT authentication error: ${a.message}`)}try{const{verifiedToken:a}=await t.json();return{storedToken:a}}catch(a){throw new Error(B("Malformed response from post jwt authentication",a))}}async function se({client:i,ecosystem:e,tokenToLink:t,storage:a}){const s=h(i,e),o=p("inAppWallet"),n=await a.getAuthCookie();if(!n)throw new Error("Failed to link account, no user logged in");const r={Authorization:`Bearer iaw-auth-token:${n}`,"Content-Type":"application/json"},l=await s(`${o}/api/2024-05-05/account/connect`,{method:"POST",headers:r,body:w({accountAuthTokenToConnect:t})});if(!l.ok){const u=await l.json();throw new Error(u.message||"Failed to link account.")}const{linkedAccounts:c}=await l.json();return c??[]}async function oe({client:i,ecosystem:e,profileToUnlink:t,allowAccountDeletion:a=!1,storage:s}){const o=h(i,e),n=p("inAppWallet"),r=await s.getAuthCookie();if(!r)throw new Error("Failed to unlink account, no user logged in");const l={Authorization:`Bearer iaw-auth-token:${r}`,"Content-Type":"application/json"},c=await o(`${n}/api/2024-05-05/account/disconnect`,{method:"POST",headers:l,body:w({type:t.type,details:t.details,allowAccountDeletion:a})});if(!c.ok){const d=await c.json();throw new Error(d.message||"Failed to unlink account.")}const{linkedAccounts:u}=await c.json();return u??[]}async function ce({client:i,ecosystem:e,storage:t}){const a=h(i,e),s=p("inAppWallet"),o=await t.getAuthCookie();if(!o)throw new Error("Failed to get linked accounts, no user logged in");const n={Authorization:`Bearer iaw-auth-token:${o}`,"Content-Type":"application/json"},r=await a(`${s}/api/2024-05-05/accounts`,{method:"GET",headers:n});if(!r.ok){const c=await r.json();throw new Error(c.message||"Failed to get linked accounts.")}const{linkedAccounts:l}=await r.json();return l??[]}function z(){return`${p("inAppWallet")}/api/2024-05-05/login/passkey/callback`}function M(i,e){return`${p("inAppWallet")}/api/2024-05-05/login/passkey?type=${i}${e?`&username=${e}`:""}`}async function le(i){var u,d,g;if(!i.passkeyClient.isAvailable())throw new Error("Passkeys are not available on this device");const e=h(i.client,i.ecosystem),t=i.username??de(i.ecosystem),s=await(await e(M("sign-up",t))).json();if(!s.challenge)throw new Error("No challenge received");const o=s.challenge,n=await i.passkeyClient.register({name:t,challenge:o,rp:i.rp}),r={};(u=i.ecosystem)!=null&&u.partnerId&&(r["x-ecosystem-partner-id"]=i.ecosystem.partnerId),(d=i.ecosystem)!=null&&d.id&&(r["x-ecosystem-id"]=i.ecosystem.id);const c=await(await e(z(),{method:"POST",headers:{"Content-Type":"application/json",...r},body:w({type:"sign-up",authenticatorData:n.authenticatorData,credentialId:n.credentialId,serverVerificationId:s.serverVerificationId,clientData:n.clientData,username:t,credential:{publicKey:n.credential.publicKey,algorithm:n.credential.algorithm},origin:n.origin,rpId:i.rp.id})})).json();if(!c||!c.storedToken)throw new Error(`Error verifying passkey: ${c.message??"unknown error"}`);return await((g=i.storage)==null?void 0:g.savePasskeyCredentialId(n.credentialId)),c}async function ue(i){var c,u,d,g;if(!i.passkeyClient.isAvailable())throw new Error("Passkeys are not available on this device");const e=h(i.client,i.ecosystem),[t,a]=await Promise.all([e(M("sign-in")).then(y=>y.json()),(c=i.storage)==null?void 0:c.getPasskeyCredentialId()]);if(!t.challenge)throw new Error("No challenge received");const s=t.challenge,o=await i.passkeyClient.authenticate({credentialId:a??void 0,challenge:s,rp:i.rp}),n={};(u=i.ecosystem)!=null&&u.partnerId&&(n["x-ecosystem-partner-id"]=i.ecosystem.partnerId),(d=i.ecosystem)!=null&&d.id&&(n["x-ecosystem-id"]=i.ecosystem.id);const l=await(await e(z(),{method:"POST",headers:{"Content-Type":"application/json",...n},body:w({type:"sign-in",authenticatorData:o.authenticatorData,credentialId:o.credentialId,serverVerificationId:t.serverVerificationId,clientData:o.clientData,signature:o.signature,origin:o.origin,rpId:i.rp.id})})).json();if(!l||!l.storedToken)throw new Error(`Error verifying passkey: ${l.message??"unknown error"}`);return await((g=i.storage)==null?void 0:g.savePasskeyCredentialId(o.credentialId)),l}function de(i){return`${(i==null?void 0:i.id)??"wallet"}-${new Date().toISOString()}`}async function he(i){const{wallet:e,chain:t,client:a,ecosystem:s}=i,o=e.getAccount()||await e.connect({client:a,chain:t}),n=h(a,s),r=await(async()=>{const u=L({authOption:"wallet",client:i.client,ecosystem:i.ecosystem}),d=await n(`${u}&address=${o.address}&chainId=${t.id}`);if(!d.ok)throw new Error("Failed to generate SIWE login payload");return await d.json()})(),{signature:l}=await J({payload:r,account:o});return await(async()=>{const u=W({authOption:"wallet",client:i.client,ecosystem:i.ecosystem}),d=await n(`${u}&signature=${l}&payload=${encodeURIComponent(r)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:w({signature:l,payload:r})});if(!d.ok)throw new Error("Failed to verify SIWE signature");return await d.json()})()}async function we({client:i,payload:e,storage:t}){const a=await t.getAuthCookie(),s=t.ecosystem,o=h(i,s);if(!a)throw new Error("No auth token found when signing message");const n={address:e.address,chainId:e.chainId,nonce:Number(e.nonce)},r=await o(`${p("inAppWallet")}/api/v1/enclave-wallet/sign-authorization`,{method:"POST",headers:{"Content-Type":"application/json","x-thirdweb-client-id":i.clientId,Authorization:`Bearer embedded-wallet-token:${a}`},body:w(n)});if(!r.ok)throw new Error(`Failed to sign message - ${r.status} ${r.statusText}`);return await r.json()}async function pe({client:i,payload:{message:e,isRaw:t,originalMessage:a,chainId:s},storage:o}){const n=await o.getAuthCookie(),r=o.ecosystem,l=h(i,r);if(!n)throw new Error("No auth token found when signing message");const c=await l(`${p("inAppWallet")}/api/v1/enclave-wallet/sign-message`,{method:"POST",headers:{"Content-Type":"application/json","x-thirdweb-client-id":i.clientId,Authorization:`Bearer embedded-wallet-token:${n}`},body:w({messagePayload:{message:e,isRaw:t,originalMessage:a,chainId:s}})});if(!c.ok)throw new Error(`Failed to sign message - ${c.status} ${c.statusText}`);return await c.json()}async function ge({client:i,payload:e,storage:t}){const a=await t.getAuthCookie(),s=t.ecosystem,o=h(i,s);if(!a)throw new Error("No auth token found when signing transaction");const n=await o(`${p("inAppWallet")}/api/v1/enclave-wallet/sign-transaction`,{method:"POST",headers:{"Content-Type":"application/json","x-thirdweb-client-id":i.clientId,Authorization:`Bearer embedded-wallet-token:${a}`},body:w({transactionPayload:e})});if(!n.ok)throw new Error(`Failed to sign transaction - ${n.status} ${n.statusText}`);return(await n.json()).signature}async function me({client:i,payload:e,storage:t}){const a=await t.getAuthCookie(),s=t.ecosystem,o=h(i,s);if(!a)throw new Error("No auth token found when signing typed data");const n=await o(`${p("inAppWallet")}/api/v1/enclave-wallet/sign-typed-data`,{method:"POST",headers:{"Content-Type":"application/json","x-thirdweb-client-id":i.clientId,Authorization:`Bearer embedded-wallet-token:${a}`},body:w({...e})});if(!n.ok)throw new Error(`Failed to sign typed data - ${n.status} ${n.statusText}`);return await n.json()}class ye{constructor({client:e,ecosystem:t,address:a,storage:s}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"address",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.ecosystem=t,this.address=a,this.localStorage=s}async postWalletSetUp(e){await this.localStorage.saveAuthCookie(e.storedToken.cookieString)}async getUserWalletStatus(){var o,n;const e=await this.localStorage.getAuthCookie();if(!e)return{status:"Logged Out"};const t=await E({authToken:e,client:this.client,ecosystem:this.ecosystem});if(!t)return{status:"Logged Out"};const a=t.wallets[0],s={email:(o=t.linkedAccounts.find(r=>r.details.email!==void 0))==null?void 0:o.details.email,phoneNumber:(n=t.linkedAccounts.find(r=>r.details.phone!==void 0))==null?void 0:n.details.phone,userWalletId:t.id||"",recoveryShareManagement:"ENCLAVE"};return a?{status:"Logged In, Wallet Initialized",walletAddress:a.address,authDetails:s,account:await this.getAccount()}:{status:"Logged In, Wallet Uninitialized",authDetails:s}}async getAccount(){const e=this.client,t=this.localStorage,a=this.address,s=this.ecosystem,o=async n=>{const r=v({client:e,chain:T(n.chainId)}),l={to:n.to?f(n.to):void 0,data:n.data,value:m(n.value),gas:m(n.gas),nonce:m(n.nonce)||A(await D(async()=>{const{eth_getTransactionCount:c}=await import("./eth_getTransactionCount-BCMAqULb.js");return{eth_getTransactionCount:c}},__vite__mapDeps([0,1,2])).then(({eth_getTransactionCount:c})=>c(r,{address:f(this.address),blockTag:"pending"}))),chainId:A(n.chainId)};return n.authorizationList&&n.authorizationList.length>0?(l.type=4,l.authorizationList=n.authorizationList,l.maxFeePerGas=m(n.maxFeePerGas),l.maxPriorityFeePerGas=m(n.maxPriorityFeePerGas)):m(n.maxFeePerGas)?(l.maxFeePerGas=m(n.maxFeePerGas),l.maxPriorityFeePerGas=m(n.maxPriorityFeePerGas),l.type=2):(l.gasPrice=m(n.gasPrice),l.type=0),ge({client:e,storage:t,payload:l})};return{address:f(a),async signTransaction(n){if(!n.chainId)throw new Error("chainId required in tx to sign");return o({chainId:n.chainId,...n})},async sendTransaction(n){const r=v({client:e,chain:T(n.chainId)}),l=await o(n),c=await F(r,l);return _({client:e,ecosystem:s,chainId:n.chainId,walletAddress:a,walletType:"inApp",transactionHash:c,contractAddress:n.to??void 0,gasPrice:n.gasPrice}),{transactionHash:c}},async signMessage({message:n,originalMessage:r,chainId:l}){const c=typeof n=="string"?{message:n,isRaw:!1,originalMessage:r,chainId:l}:{message:typeof n.raw=="string"?n.raw:Y(n.raw),isRaw:!0,originalMessage:r,chainId:l},{signature:u}=await pe({client:e,payload:c,storage:t});return u},async signTypedData(n){const r=N(n),{signature:l}=await me({client:e,payload:r,storage:t});return l},async signAuthorization(n){const r=await we({client:e,payload:n,storage:t});return{address:f(r.address),chainId:Number.parseInt(r.chainId),nonce:BigInt(r.nonce),r:BigInt(r.r),s:BigInt(r.s),yParity:Number.parseInt(r.yParity)}}}}}function m(i){return i===void 0||G(i)?i:A(i)}const fe={height:"100%",width:"100%",border:"none",backgroundColor:"transparent",colorScheme:"light",position:"fixed",top:"0px",right:"0px",zIndex:"2147483646",display:"none",pointerEvents:"all"},k=new Map;class be{constructor({link:e,baseUrl:t,iframeId:a,container:s,onIframeInitialize:o,localStorage:n,clientId:r,ecosystem:l}){if(Object.defineProperty(this,"iframe",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"POLLING_INTERVAL_SECONDS",{enumerable:!0,configurable:!0,writable:!0,value:1.4}),Object.defineProperty(this,"iframeBaseUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.localStorage=n,this.clientId=r,this.ecosystem=l,this.iframeBaseUrl=t,typeof document>"u")return;s=s??document.body;let c=document.getElementById(a);const u=new URL(e);if(!c||c.src!==u.href){c=document.createElement("iframe");const d={...fe};Object.assign(c.style,d),c.setAttribute("id",a),c.setAttribute("fetchpriority","high"),s.appendChild(c),c.src=u.href;const g=y=>{if(y.data.eventType==="ewsIframeLoaded"){if(window.removeEventListener("message",g),!c){console.warn("thirdweb iFrame not found");return}this.onIframeLoadHandler(c,o)()}};window.addEventListener("message",g)}this.iframe=c}async onIframeLoadedInitVariables(){var e,t;return{authCookie:await this.localStorage.getAuthCookie(),deviceShareStored:await this.localStorage.getDeviceShare(),walletUserId:await this.localStorage.getWalletUserId(),clientId:this.clientId,partnerId:(e=this.ecosystem)==null?void 0:e.partnerId,ecosystemId:(t=this.ecosystem)==null?void 0:t.id}}onIframeLoadHandler(e,t){return async()=>{var o;const a=new MessageChannel,s=new Promise((n,r)=>{a.port1.onmessage=l=>{const{data:c}=l;a.port1.close(),c.success||r(new Error(c.error)),k.set(e.src,!0),t&&t(),n(!0)}});(o=e==null?void 0:e.contentWindow)==null||o.postMessage({eventType:"initIframe",data:await this.onIframeLoadedInitVariables()},this.iframeBaseUrl,[a.port2]),await s}}async call({procedureName:e,params:t,showIframe:a=!1}){var n;if(!this.iframe)throw new Error("Iframe not found. You are likely calling this from the backend where the DOM is not available.");for(;!k.get(this.iframe.src);)await b(this.POLLING_INTERVAL_SECONDS*1e3);a&&(this.iframe.style.display="block",await b(.005*1e3));const s=new MessageChannel,o=new Promise((r,l)=>{s.port1.onmessage=async c=>{const{data:u}=c;s.port1.close(),a&&(await b(.1*1e3),this.iframe&&(this.iframe.style.display="none")),u.success?r(u.data):l(new Error(u.error))}});return(n=this.iframe.contentWindow)==null||n.postMessage({eventType:e,data:{...t,...await this.onIframeLoadedInitVariables()}},this.iframeBaseUrl,[s.port2]),o}destroy(){this.iframe&&k.delete(this.iframe.src)}}class Ie extends be{constructor({clientId:e,baseUrl:t,ecosystem:a}){super({iframeId:ve+((a==null?void 0:a.id)||""),link:ke({clientId:e,path:H,ecosystem:a,baseUrl:t}).href,baseUrl:t,container:typeof document>"u"?void 0:document.body,localStorage:new S({storage:P,clientId:e,ecosystem:a}),clientId:e,ecosystem:a}),this.clientId=e,this.ecosystem=a}}function ke({clientId:i,baseUrl:e,path:t,ecosystem:a,queryParams:s}){var n;const o=new URL(`${t}`,e);if(s)for(const r of Object.keys(s))o.searchParams.set(r,((n=s[r])==null?void 0:n.toString())||"");return o.searchParams.set("clientId",i),(a==null?void 0:a.partnerId)!==void 0&&o.searchParams.set("partnerId",a.partnerId),(a==null?void 0:a.id)!==void 0&&o.searchParams.set("ecosystemId",a.id),o}const ve="thirdweb-in-app-wallet-iframe";async function Te({client:i,ecosystem:e,authToken:t}){const s=await h(i,e)(`${p("inAppWallet")}/api/v1/enclave-wallet/generate`,{method:"POST",headers:{"Content-Type":"application/json","x-thirdweb-client-id":i.clientId,Authorization:`Bearer embedded-wallet-token:${t}`}});if(!s.ok)throw new Error(`Failed to generate wallet - ${s.status} ${s.statusText}`);const{wallet:o}=await s.json();return o}class Ae{constructor({baseUrl:e,querier:t,preLogin:a,postLogin:s,client:o,ecosystem:n}){Object.defineProperty(this,"LoginQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"preLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"postLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"baseUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.baseUrl=e,this.LoginQuerier=t,this.preLogin=a,this.postLogin=s,this.client=o,this.ecosystem=n}async sendEmailLoginOtp({email:e}){return await this.LoginQuerier.call({procedureName:"sendThirdwebEmailLoginOtp",params:{email:e}})}async sendSmsLoginOtp({phoneNumber:e}){return await this.LoginQuerier.call({procedureName:"sendThirdwebSmsLoginOtp",params:{phoneNumber:e}})}}class Pe extends Ae{async authenticateWithModal(){return this.LoginQuerier.call({procedureName:"loginWithThirdwebModal",params:void 0,showIframe:!0})}async loginWithModal(){await this.preLogin();const e=await this.authenticateWithModal();return this.postLogin(e)}async authenticateWithIframe({email:e}){return this.LoginQuerier.call({procedureName:"loginWithThirdwebModal",params:{email:e},showIframe:!0})}async loginWithIframe({email:e}){await this.preLogin();const t=await this.authenticateWithIframe({email:e});return this.postLogin(t)}async authenticateWithCustomJwt({encryptionKey:e,jwt:t}){if(!e||e.length===0)throw new Error("Encryption key is required for custom jwt auth");return this.LoginQuerier.call({procedureName:"loginWithCustomJwt",params:{encryptionKey:e,jwt:t}})}async loginWithCustomJwt({encryptionKey:e,jwt:t}){if(!e||e.length===0)throw new Error("Encryption key is required for custom jwt auth");await this.preLogin();const a=await this.authenticateWithCustomJwt({encryptionKey:e,jwt:t});return this.postLogin(a)}async authenticateWithCustomAuthEndpoint({encryptionKey:e,payload:t}){return this.LoginQuerier.call({procedureName:"loginWithCustomAuthEndpoint",params:{encryptionKey:e,payload:t}})}async loginWithCustomAuthEndpoint({encryptionKey:e,payload:t}){if(!e||e.length===0)throw new Error("Encryption key is required for custom auth");await this.preLogin();const a=await this.authenticateWithCustomAuthEndpoint({encryptionKey:e,payload:t});return this.postLogin(a)}async authenticateWithEmailOtp({email:e,otp:t,recoveryCode:a}){return this.LoginQuerier.call({procedureName:"verifyThirdwebEmailLoginOtp",params:{email:e,otp:t,recoveryCode:a}})}async loginWithEmailOtp({email:e,otp:t,recoveryCode:a}){const s=await this.authenticateWithEmailOtp({email:e,otp:t,recoveryCode:a});return this.postLogin(s)}async authenticateWithSmsOtp({phoneNumber:e,otp:t,recoveryCode:a}){return this.LoginQuerier.call({procedureName:"verifyThirdwebSmsLoginOtp",params:{phoneNumber:e,otp:t,recoveryCode:a}})}async loginWithSmsOtp({phoneNumber:e,otp:t,recoveryCode:a}){const s=await this.authenticateWithSmsOtp({phoneNumber:e,otp:t,recoveryCode:a});return this.postLogin(s)}}class Le{constructor({client:e,querier:t,onAuthSuccess:a,ecosystem:s,baseUrl:o,localStorage:n}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"AuthQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onAuthSuccess",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"BaseLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.ecosystem=s,this.AuthQuerier=t,this.localStorage=n,this.onAuthSuccess=a,this.BaseLogin=new Pe({postLogin:async r=>this.postLogin(r),preLogin:async()=>{await this.preLogin()},ecosystem:s,querier:t,client:e,baseUrl:o})}async preLogin(){await this.logout()}async postLogin({storedToken:e,walletDetails:t}){return e.shouldStoreCookieString&&await this.localStorage.saveAuthCookie(e.cookieString),await this.onAuthSuccess({storedToken:e,walletDetails:t})}async loginWithAuthToken(e,t){var o;e.storedToken.authProvider!=="Backend"&&await this.preLogin();const a=await E({authToken:e.storedToken.cookieString,client:this.client,ecosystem:this.ecosystem});if(!a)throw new Error("Cannot login, no user found for auth token");if(a.wallets.length>0&&((o=a.wallets[0])==null?void 0:o.type)==="enclave")return this.postLogin({storedToken:e.storedToken,walletDetails:{walletAddress:a.wallets[0].address}});if(a.wallets.length===0){const n=await Te({authToken:e.storedToken.cookieString,client:this.client,ecosystem:this.ecosystem});return this.postLogin({storedToken:e.storedToken,walletDetails:{walletAddress:n.address}})}const s=await this.AuthQuerier.call({procedureName:"loginWithStoredTokenDetails",params:{storedToken:e.storedToken,recoveryCode:t}});return this.postLogin(s)}async loginWithModal(){return this.BaseLogin.loginWithModal()}async authenticateWithModal(){return this.BaseLogin.authenticateWithModal()}async loginWithIframe(e){return this.BaseLogin.loginWithIframe(e)}async authenticateWithIframe(e){return this.BaseLogin.authenticateWithIframe(e)}async loginWithCustomJwt(e){return this.BaseLogin.loginWithCustomJwt(e)}async authenticateWithCustomJwt(e){return this.BaseLogin.authenticateWithCustomJwt(e)}async loginWithCustomAuthEndpoint(e){return this.BaseLogin.loginWithCustomAuthEndpoint(e)}async authenticateWithCustomAuthEndpoint(e){return this.BaseLogin.authenticateWithCustomAuthEndpoint(e)}async sendEmailLoginOtp({email:e}){return this.BaseLogin.sendEmailLoginOtp({email:e})}async sendSmsLoginOtp({phoneNumber:e}){return this.BaseLogin.sendSmsLoginOtp({phoneNumber:e})}async loginWithEmailOtp(e){return await this.preLogin(),this.BaseLogin.loginWithEmailOtp(e)}async authenticateWithEmailOtp(e){return this.BaseLogin.authenticateWithEmailOtp(e)}async loginWithSmsOtp(e){return await this.preLogin(),this.BaseLogin.loginWithSmsOtp(e)}async authenticateWithSmsOtp(e){return this.BaseLogin.authenticateWithSmsOtp(e)}async logout(){const e=await this.localStorage.removeAuthCookie(),t=await this.localStorage.removeWalletUserId();return{success:e||t}}}const We=async i=>{const{client:e,ecosystem:t}=i,a=L({client:e,ecosystem:t,authOption:i.strategy}),s={"Content-Type":"application/json","x-client-id":e.clientId};t!=null&&t.id&&(s["x-ecosystem-id"]=t.id),t!=null&&t.partnerId&&(s["x-ecosystem-partner-id"]=t.partnerId);const o=(()=>{switch(i.strategy){case"email":return{email:i.email};case"phone":return{phone:i.phoneNumber}}})(),n=await fetch(a,{method:"POST",headers:s,body:w(o)});if(!n.ok)throw new Error("Failed to send verification code");return await n.json()},j=async i=>{const{client:e,ecosystem:t}=i,a=W({authOption:i.strategy,client:i.client,ecosystem:i.ecosystem}),s={"Content-Type":"application/json","x-client-id":e.clientId};t!=null&&t.id&&(s["x-ecosystem-id"]=t.id),t!=null&&t.partnerId&&(s["x-ecosystem-partner-id"]=t.partnerId);const o=(()=>{switch(i.strategy){case"email":return{email:i.email,code:i.verificationCode};case"phone":return{phone:i.phoneNumber,code:i.verificationCode}}})(),n=await fetch(a,{method:"POST",headers:s,body:w(o)});if(!n.ok)throw new Error("Failed to verify verification code");return await n.json()};class ${constructor({client:e,ecosystem:t,querier:a,localStorage:s}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"walletManagerQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.ecosystem=t,this.walletManagerQuerier=a,this.localStorage=s}async postWalletSetUp(e){e.deviceShareStored&&await this.localStorage.saveDeviceShare(e.deviceShareStored,e.storedToken.authDetails.userWalletId)}async getUserWalletStatus(){const e=await this.walletManagerQuerier.call({procedureName:"getUserStatus",params:void 0});return e.status==="Logged In, Wallet Initialized"?{status:"Logged In, Wallet Initialized",...e.user,account:await this.getAccount()}:e.status==="Logged In, New Device"?{status:"Logged In, New Device",...e.user}:e.status==="Logged In, Wallet Uninitialized"?{status:"Logged In, Wallet Uninitialized",...e.user}:{status:e.status}}async getAccount(){var n;const e=this.walletManagerQuerier,t=this.client,a=(n=this.ecosystem)==null?void 0:n.partnerId,{address:s}=await e.call({procedureName:"getAddress",params:void 0}),o=async r=>{const l={to:r.to??void 0,data:r.data,value:r.value,gasLimit:r.gas,nonce:r.nonce,chainId:r.chainId};r.maxFeePerGas?(l.accessList=r.accessList,l.maxFeePerGas=r.maxFeePerGas,l.maxPriorityFeePerGas=r.maxPriorityFeePerGas,l.type=2):(l.gasPrice=r.gasPrice,l.type=0);const c=C().rpc,{signedTransaction:u}=await e.call({procedureName:"signTransaction",params:{transaction:l,chainId:r.chainId,partnerId:a,rpcEndpoint:`https://${r.chainId}.${c}`}});return u};return{address:f(s),async signTransaction(r){if(!r.chainId)throw new Error("chainId required in tx to sign");return o({...r,chainId:r.chainId})},async sendTransaction(r){const l=v({client:t,chain:T(r.chainId)}),c=await o(r),u=await F(l,c);return _({client:t,chainId:r.chainId,walletAddress:s,walletType:"inApp",transactionHash:u,contractAddress:r.to??void 0,gasPrice:r.gasPrice}),{transactionHash:u}},async signMessage({message:r}){const l=typeof r=="string"?r:r.raw instanceof Uint8Array?r.raw:x(r.raw),{signedMessage:c}=await e.call({procedureName:"signMessage",params:{message:l,partnerId:a,chainId:1}});return c},async signTypedData(r){var O;const l=N(r);(O=l.types)!=null&&O.EIP712Domain&&(l.types.EIP712Domain=void 0);const c=l.domain,u=c==null?void 0:c.chainId,g={...c!=null&&c.verifyingContract?{verifyingContract:c==null?void 0:c.verifyingContract}:{},name:c==null?void 0:c.name,version:c==null?void 0:c.version};u&&(g.chainId=u);const y=C().rpc,{signedTypedData:R}=await e.call({procedureName:"signTypedDataV4",params:{domain:g,types:l.types,message:l.message,chainId:Number.parseInt(BigInt(u||1).toString()),partnerId:a,rpcEndpoint:`https://${u}.${y}`}});return R}}}}class Be{isClientIdLegacyPaper(e){return e.indexOf("-")>0&&e.length===36}constructor({client:e,onAuthSuccess:t,ecosystem:a,passkeyDomain:s,storage:o}){if(Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"querier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"storage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"wallet",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"auth",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"passkeyDomain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.isClientIdLegacyPaper(e.clientId))throw new Error("You are using a legacy clientId. Please use the clientId found on the thirdweb dashboard settings page");const n=p("inAppWallet");this.client=e,this.ecosystem=a,this.passkeyDomain=s,this.storage=new S({storage:o??Ee(),clientId:e.clientId,ecosystem:a}),this.querier=new Ie({clientId:e.clientId,ecosystem:a,baseUrl:n}),this.auth=new Le({client:e,querier:this.querier,baseUrl:n,localStorage:this.storage,ecosystem:a,onAuthSuccess:async r=>{if(t==null||t(r),r.storedToken.authDetails.walletType==="sharded"&&(await this.querier.call({procedureName:"migrateFromShardToEnclave",params:{storedToken:r.storedToken}})||console.warn("Failed to migrate from sharded to enclave wallet, continuing with sharded wallet")),this.wallet=await this.initializeWallet(r.storedToken.cookieString),!this.wallet)throw new Error("Failed to initialize wallet");const l="deviceShareStored"in r.walletDetails?r.walletDetails.deviceShareStored:void 0;return await this.wallet.postWalletSetUp({storedToken:r.storedToken,deviceShareStored:l}),this.wallet instanceof $&&await this.querier.call({procedureName:"initIframe",params:{partnerId:a==null?void 0:a.partnerId,ecosystemId:a==null?void 0:a.id,clientId:this.client.clientId,deviceShareStored:"deviceShareStored"in r.walletDetails?r.walletDetails.deviceShareStored:null,walletUserId:r.storedToken.authDetails.userWalletId,authCookie:r.storedToken.cookieString}}),{user:{status:"Logged In, Wallet Initialized",authDetails:r.storedToken.authDetails,account:await this.wallet.getAccount(),walletAddress:r.walletDetails.walletAddress}}}})}async initializeWallet(e){var s;const t=await this.storage.getAuthCookie();if(!e&&t===null)throw new Error("No auth token provided and no stored auth token found to initialize the wallet");const a=await E({authToken:e||t,client:this.client,ecosystem:this.ecosystem});if(!a)throw new Error("Cannot initialize wallet, no user logged in");if(a.wallets.length===0)throw new Error("Cannot initialize wallet, this user does not have a wallet generated yet");return((s=a.wallets[0])==null?void 0:s.type)==="enclave"?new ye({client:this.client,ecosystem:this.ecosystem,address:a.wallets[0].address,storage:this.storage}):new $({client:this.client,ecosystem:this.ecosystem,querier:this.querier,localStorage:this.storage})}async getUser(){if(!this.wallet){const e=await this.storage.getAuthCookie();if(!e)return{status:"Logged Out"};this.wallet=await this.initializeWallet(e)}if(!this.wallet)throw new Error("Wallet not initialized");return await this.wallet.getUserWalletStatus()}getAccount(){if(!this.wallet)throw new Error("Wallet not initialized");return this.wallet.getAccount()}async preAuthenticate(e){return We({...e,client:this.client,ecosystem:this.ecosystem})}async authenticateWithRedirect(e,t,a){return Q({authOption:e,client:this.client,ecosystem:this.ecosystem,redirectUrl:a,mode:t})}async loginWithAuthToken(e,t){return this.auth.loginWithAuthToken(e,t)}async authenticate(e){const t=e.strategy;switch(t){case"email":return j({...e,client:this.client,ecosystem:this.ecosystem});case"phone":return j({...e,client:this.client,ecosystem:this.ecosystem});case"auth_endpoint":return ae({payload:e.payload,client:this.client,ecosystem:this.ecosystem});case"jwt":return re({jwt:e.jwt,client:this.client,ecosystem:this.ecosystem});case"passkey":return this.passkeyAuth(e);case"iframe_email_verification":return this.auth.authenticateWithIframe({email:e.email});case"iframe":return this.auth.authenticateWithModal();case"apple":case"facebook":case"google":case"telegram":case"github":case"twitch":case"farcaster":case"line":case"x":case"steam":case"coinbase":case"discord":return q({authOption:t,client:this.client,ecosystem:this.ecosystem,closeOpenedWindow:e.closeOpenedWindow,openedWindow:e.openedWindow});case"guest":return ne({client:this.client,ecosystem:this.ecosystem,storage:P});case"backend":return ie({client:this.client,walletSecret:e.walletSecret,ecosystem:this.ecosystem});case"wallet":return he({ecosystem:this.ecosystem,client:this.client,wallet:e.wallet,chain:e.chain})}}async connect(e){const t=e.strategy;switch(t){case"auth_endpoint":case"jwt":{const a=await this.authenticate(e);return await this.loginWithAuthToken(a,e.encryptionKey)}case"iframe_email_verification":return this.auth.loginWithIframe({email:e.email});case"iframe":return this.auth.loginWithModal();case"passkey":{const a=await this.passkeyAuth(e);return this.loginWithAuthToken(a)}case"backend":case"phone":case"email":case"wallet":case"apple":case"facebook":case"google":case"farcaster":case"telegram":case"github":case"line":case"x":case"guest":case"coinbase":case"twitch":case"steam":case"discord":{const a=await this.authenticate(e);return await this.auth.loginWithAuthToken(a)}default:Se(t)}}async logout(){return await this.auth.logout()}async passkeyAuth(e){const{PasskeyWebClient:t}=await D(async()=>{const{PasskeyWebClient:r}=await import("./passkeys-DpDg0PTU.js");return{PasskeyWebClient:r}},__vite__mapDeps([3,1,2,4])),{passkeyName:a,storeLastUsedPasskey:s=!0}=e,o=new t,n=this.storage;return e.type==="sign-up"?le({client:this.client,ecosystem:this.ecosystem,username:a,passkeyClient:o,storage:s?n:void 0,rp:{id:this.passkeyDomain??window.location.hostname,name:this.passkeyDomain??window.document.title}}):ue({client:this.client,ecosystem:this.ecosystem,passkeyClient:o,storage:s?n:void 0,rp:{id:this.passkeyDomain??window.location.hostname,name:this.passkeyDomain??window.document.title}})}async linkProfile(e){const{storedToken:t}=await this.authenticate(e);return await se({client:e.client,tokenToLink:t.cookieString,storage:this.storage,ecosystem:e.ecosystem||this.ecosystem})}async unlinkProfile(e,t){return await oe({client:this.client,storage:this.storage,ecosystem:this.ecosystem,profileToUnlink:e,allowAccountDeletion:t})}async getProfiles(){return ce({client:this.client,ecosystem:this.ecosystem,storage:this.storage})}}function Se(i,e){throw new Error(`Invalid param: ${i}`)}function Ee(){return typeof window<"u"&&window.localStorage?P:X}export{Be as InAppWebConnector};
